{"version":3,"file":"PageView.js","names":["EMPTY_RESULT","indexes","noResults","query","textAll","textEmpty","totalItems","urlAll","PageView","config","_this","isEmpty","searchQuery","time","hide","visible","request","_this$xhr","xhr","abort","result","ts","Date","getTime","loading","filters","filterList","subscribe","page","forEach","value","key","clear","_jquery","ajax","url","dataType","type","data","q","store_id","storeId","cat","limit","p","index","activeIndex","buckets","currency","success","shouldSwitchActiveIndex","_underscore","each","identifier","idx","find","_knockout","observable","Map","sendRequest","debounce","searchBarView","SearchBarView","indexListView","IndexListView","itemListView","ItemListView","sidebarView","SidebarView","pagingView","PagingView","toggleClass","document","on","e"],"sources":["../../ts/src/in-page/PageView.ts"],"sourcesContent":["import { Config, Result } from \"../types\"\nimport _ from \"underscore\"\nimport ko from \"knockout\"\nimport $ from \"jquery\"\nimport { IndexListView } from \"./IndexListView\"\nimport { SearchBarView } from \"./SearchBarView\"\nimport { ItemListView } from \"./ItemListView\"\nimport { SidebarView } from \"./SidebarView\"\nimport { PagingView } from \"./PagingView\"\n\nconst EMPTY_RESULT = {\n    indexes:    [],\n    noResults:  false,\n    query:      \"\",\n    textAll:    \"\",\n    textEmpty:  \"\",\n    totalItems: 0,\n    urlAll:     \"\",\n}\n\nexport class PageView {\n    visible: KnockoutObservable<boolean>\n    loading: KnockoutObservable<boolean>\n    sendRequest: () => void\n    xhr: JQueryXHR | null\n    config: Config\n    page: KnockoutObservable<number>\n    result: KnockoutObservable<Result>\n    time: KnockoutObservable<number>\n\n    activeIndex: KnockoutObservable<string>\n    searchQuery: KnockoutObservable<string>\n    filterList: KnockoutObservable<Map<string, string>>\n\n    searchBarView: SearchBarView\n    indexListView: IndexListView\n    itemListView: ItemListView\n    sidebarView: SidebarView\n    pagingView: PagingView\n\n    constructor(config: Config) {\n        this.config = config\n        this.page = ko.observable(1)\n        this.visible = ko.observable(false)\n        this.loading = ko.observable(false)\n        this.searchQuery = ko.observable(\"\")\n        this.activeIndex = ko.observable(\"magento_catalog_product\")\n        this.filterList = ko.observable(new Map<string, string>())\n        this.sendRequest = _.debounce(this.request, 10)\n        this.xhr = null\n        this.result = ko.observable(EMPTY_RESULT)\n        this.time = ko.observable(0)\n\n        this.searchBarView = new SearchBarView({\n            query:   this.searchQuery,\n            visible: this.visible,\n        })\n\n        this.indexListView = new IndexListView({\n            result:      this.result,\n            activeIndex: this.activeIndex,\n        })\n\n        this.itemListView = new ItemListView({\n            result:      this.result,\n            activeIndex: this.activeIndex,\n        })\n\n        this.sidebarView = new SidebarView({\n            result:      this.result,\n            activeIndex: this.activeIndex,\n            filterList:  this.filterList,\n        })\n\n        this.pagingView = new PagingView({\n            result:      this.result,\n            activeIndex: this.activeIndex,\n            page:        this.page,\n        })\n\n        this.visible.subscribe(visible => {\n            $(\"html\").toggleClass(\"mstInPage\", visible)\n        })\n\n        $(document).on(\"keyup\", e => {\n            if (e.key === \"Escape\") {\n                this.searchQuery() == \"\" && this.visible(false)\n            }\n        })\n\n        this.searchQuery.subscribe(this.sendRequest)\n        this.filterList.subscribe(this.sendRequest)\n        this.page.subscribe(this.sendRequest)\n    }\n\n    isEmpty = () => {\n        return this.searchQuery() === \"\" || this.time() === 0\n    }\n\n    hide = () => {\n        this.visible(false)\n    }\n\n    request = () => {\n        this.xhr?.abort()\n\n        if (this.searchQuery() === \"\") {\n            this.result(EMPTY_RESULT)\n            this.time(0)\n\n            return\n        }\n\n        const ts = new Date().getTime()\n\n        this.loading(true)\n        let filters: any = {}\n\n        this.filterList.subscribe(() => {\n            this.page(1)\n        })\n\n        if (this.result().query == this.searchQuery()) {\n            this.filterList().forEach((value, key) => filters[key] = value)\n        } else {\n            this.page(1)\n            this.filterList().clear()\n            filters = {}\n        }\n\n        this.xhr = $.ajax({\n            url:      this.config.url,\n            dataType: \"json\",\n            type:     \"GET\",\n            data:     {\n                q:        this.searchQuery(),\n                store_id: this.config.storeId,\n                cat:      false,\n                limit:    this.config.limit,\n                p:        this.page,\n                index:    this.activeIndex,\n                buckets:  [ \"category_ids\" ],\n                filters:  filters,\n                currency: this.config.currency,\n            },\n            success:  (data: Result) => {\n                this.loading(false)\n                this.result(data)\n\n                let shouldSwitchActiveIndex = false\n\n                _.each(data.indexes, index => {\n                    if (index.identifier == this.activeIndex() && index.totalItems === 0) {\n                        shouldSwitchActiveIndex = true\n                    }\n                })\n\n                if (shouldSwitchActiveIndex) {\n                    const idx = _.find(data.indexes, idx => {\n                        return idx.totalItems > 0\n                    })\n                    if (idx) {\n                        this.activeIndex(idx.identifier)\n                    }\n                }\n\n                this.time((new Date().getTime() - ts) / 1000)\n            },\n        })\n    }\n}\n"],"mappings":"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"}